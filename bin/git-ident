#!/bin/sh -e

OPTS_SPEC="\
git-ident [options] <command>

Clumsy script for managing various git identities. Common commands:

list
create <account> <name> <email>
map <account> github|bitbucket <remote-account>
init <account>
key <acount>
regenerate

--
h,help      show the help
"

main() {
    eval "$(echo "$OPTS_SPEC" | git rev-parse --parseopt --stop-at-non-option -- "$@" || echo exit $?)"

    while test $# -ne 0
    do
        case "$1" in
            --)
                shift
                break
                ;;
            *)
                break
                ;;
        esac
    done

    case "$1" in
        list)
            shift
            list "$@"
            ;;
        create)
            shift
            create "$@"
            ;;
        map)
            shift
            map "$@"
            ;;
        key)
            shift
            key "$@"
            ;;
        regen|regenerate)
            write_config_files
            ;;
        init)
            shift
            init "$@"
            ;;
    esac
}

list() {
    git config -f ~/.config/git-ident/identities -l |
        sed -n 's/^identity\.\(.*\)\..*=.*/\1/p' |
        sort |
        uniq
}

create() {
    if [ $# -ne 3 ]
    then
        echo "Usage: git-ident create <account> <name> <email>"
        exit 1
    fi

    account=$1
    name=$2
    email=$3

    identify_file_text="~/.ssh/git-ident-$account"
    identify_file_path=~/.ssh/git-ident-$account

    if [ -f $identify_file_path ]
    then
        echo "Key already exists, not overwriting"
    else
        ssh-keygen -f $identify_file_path
    fi

    echo "Adding identities to ~/.config/git-ident/identities"
    mkdir -p ~/.config/git-ident
    git config -f ~/.config/git-ident/identities "identity.$account.key" "$identify_file_text"
    git config -f ~/.config/git-ident/identities "identity.$account.public" "$identify_file_text.pub"
    git config -f ~/.config/git-ident/identities "identity.$account.name" "$name"
    git config -f ~/.config/git-ident/identities "identity.$account.email" "$email"

    write_config_files
}

map() {
    if [ $# -ne 3 ]
    then
        echo "Usage: git-ident map <account> github|bitbucket <remote-account>"
        exit 1
    fi

    account=$1
    service=$2
    remote=$3

    case "$service" in
        github|bitbucket)
            git config -f ~/.config/git-ident/identities --add "identity.$account.map-$service" "$remote"
            ;;
        *)
            echo "Unknown service: $service"
            exit 1
            ;;
    esac

    write_config_files
}

key() {
    if [ $# -ne 1 ]
    then
        echo "Usage: git-ident key <account>"
        exit 1
    fi

    account=$1
    public_file_text=$(git config -f ~/.config/git-ident/identities --get identity.${account}.public)
    public_file_path=$(echo $public_file_text | sed "s@^~\/@${HOME}\/@")

    if [ ! -f $public_file_path ]
    then
        echo "Can't find public key for ${account}"
        exit 1
    fi

    echo Key:
    echo
    cat $public_file_path
    echo

    if which pbcopy > /dev/null
    then
        echo "Copying to clipboard using pbcopy"
        cat $public_file_path | pbcopy
    elif which xsel > /dev/null
    then
        echo "Copying to clipboard using xsel"
        cat $public_file_path | xsel --clipboard --input
    elif which xclip > /dev/null
    then
        echo "Copying to clipboard using xclip"
        cat $public_file_path | xclip -selection clipboard
    elif which putclip > /dev/null
    then
        echo "Copying to clipboard using putclip"
        cat $public_file_path | putclip
    else
        echo "Unable to copy to clipboard"
    fi
}

init() {
    if [ $# -ne 1 ]
    then
        echo "Usage: git-ident init <account>"
        exit 1
    fi

    account=$1

    name=$(git config -f ~/.config/git-ident/identities --get identity.${account}.name)
    email=$(git config -f ~/.config/git-ident/identities --get identity.${account}.email)

    echo "Committing as: $name <$email>"

    git config user.email "$email"
    git config user.name "$name"
}

write_config_files() {
    temp_file1=$(mktemp)
    sed '/# BEGIN GIT IDENT CONFIG/,/# END GIT IDENT CONFIG/d' ~/.ssh/config > $temp_file1

    echo '# BEGIN GIT IDENT CONFIG' >> $temp_file1
    echo '#' >> $temp_file1
    echo '# AUTO-GENERATED SETTINGS, DO NOT EDIT' >> $temp_file1

    echo >> $temp_file1

    for x in $(git config -f ~/.config/git-ident/identities -l | sed -n 's/^identity\.\(.*\)\.key=\(.*\)/\1!\2/p');
    do
        IFS=!
        set $x
        unset IFS

        account=$1
        identify_file_text=$2

        echo "# Keys for git identity ${account}" >> $temp_file1
        echo >> $temp_file1
        echo "Host bitbucket-${account}" >> $temp_file1
        echo "Hostname bitbucket.org" >> $temp_file1
        echo "IdentityFile $identify_file_text" >> $temp_file1
        echo >> $temp_file1
        echo "Host github-${account}" >> $temp_file1
        echo "Hostname github.com" >> $temp_file1
        echo "IdentityFile ${identify_file_text}" >> $temp_file1
        echo >> $temp_file1
    done

    echo '# END GIT IDENT CONFIG' >> $temp_file1

    temp_file2=$(mktemp)
    echo '# AUTO-GENERATED FILE, DO NOT EDIT' >> $temp_file2
    echo >> $temp_file2

    for x in $(git config -f ~/.config/git-ident/identities -l | sed -n 's/^identity\.\(.*\)\.map-\(.*\)=\(.*\)/\1!\2!\3/p');
    do
        IFS=!
        set $x
        unset IFS

        account=$1
        service=$2
        remote=$3

        case $service in
            github)
                git config -f $temp_file2 "url.git@github-$account:$remote/.insteadOf" "git@github.com:$remote/"
                ;;
            bitbucket)
                git config -f $temp_file2 "url.git@bitbucket-$account:$remote/.insteadOf" "git@bitbucket.org:$remote/"
                ;;
            *)
                echo "Unknown mapped service: $service"
                ;;
        esac
    done

    mv $temp_file1 ~/.ssh/config
    mv $temp_file2 ~/.config/git-ident/gitconfig
}

main "$@"
